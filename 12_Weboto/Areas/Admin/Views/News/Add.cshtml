@model _12_Weboto.Models.News

@{
    ViewData["Title"] = "Tạo tin tức mới";
}

<h2>Tạo tin tức mới</h2>

<form asp-action="Add" method="post" enctype="multipart/form-data">
    <div class="form-group">
        <label asp-for="Title"></label>
        <input asp-for="Title" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="Content"></label>
        <div id="toolbar">
            <span class="ql-formats">
                <select class="ql-font">
                    <option value="sans-serif" selected>Sans Serif</option>
                    <option value="serif">Serif</option>
                    <option value="monospace">Monospace</option>
                    <option value="times-new-roman">Times New Roman</option>
                    <option value="arial">Arial</option>
                    <option value="comic-sans-ms">Comic Sans MS</option>
                </select>
                <select class="ql-size">
                    <option value="small">Nhỏ</option>
                    <option selected>Vừa</option>
                    <option value="large">Lớn</option>
                    <option value="huge">Rất lớn</option>
                </select>
            </span>
            <span class="ql-formats">
                <button class="ql-bold"></button>
                <button class="ql-italic"></button>
                <button class="ql-underline"></button>
                <button class="ql-clean"></button>
            </span>
            <span class="ql-formats">
                <button class="ql-list" value="ordered"></button>
                <button class="ql-list" value="bullet"></button>
            </span>
            <span class="ql-formats">
                <button class="ql-link"></button>
                <button class="ql-image"></button>
            </span>
        </div>
        <div id="editor-container"></div>
        <textarea asp-for="Content" id="Content" class="form-control" hidden></textarea>
    </div>

    <div class="form-group">
        <label asp-for="CreatedBy"></label>
        <input asp-for="CreatedBy" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="CategoryId">Danh mục</label>
        <select asp-for="CategoryId" class="form-control" asp-items="@(new SelectList(ViewBag.Categories, "Id", "Name"))"></select>
    </div>

    <div>
        <label>Chọn ảnh</label>
        <input type="file" id="imageInput" name="Images" multiple class="form-control" />
    </div>

    <div id="imagePreview" class="mt-3 d-flex flex-wrap"></div>
    <button type="button" id="formatContent" class="btn btn-primary">Định dạng nội dung</button>
    <button type="submit" class="btn btn-success">Lưu</button>
</form>

<!-- Quill JS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<style>
    .ql-editor img {
        max-width: 100%;
        height: auto;
        cursor: grab;
        display: inline-block;
        resize: both;
        overflow: auto;
    }

    .ql-font-times-new-roman {
        font-family: "Times New Roman", serif;
    }

    .ql-font-arial {
        font-family: Arial, sans-serif;
    }

    .ql-font-comic-sans-ms {
        font-family: "Comic Sans MS", cursive, sans-serif;
    }

    #editor-container {
        height: 400px;
    }

    .delete-btn {
        display: none;
        position: absolute;
        top: -10px;
        right: -10px;
        background-color: red;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        text-align: center;
        cursor: pointer;
    }

    .img-wrapper {
        position: relative;
        display: inline-block;
    }
</style>

<script>
    var quill = new Quill('#editor-container', {
        theme: 'snow',
        placeholder: 'Nhập nội dung...',
        modules: {
            toolbar: "#toolbar"
        }
    });

    document.querySelector('form').onsubmit = function() {
        document.getElementById("Content").value = quill.root.innerHTML;
    };

    document.getElementById('imageInput').addEventListener('change', function(event) {
        let files = event.target.files;
        if (files.length > 0) {
            for (let i = 0; i < files.length; i++) {
                let reader = new FileReader();
                reader.onload = function(e) {
                    let range = quill.getSelection();
                    let img = document.createElement('img');
                    img.src = e.target.result;
                    img.classList.add('resize-img');
                    let wrapper = document.createElement('span');
                    wrapper.classList.add('img-wrapper');
                    let deleteButton = document.createElement('button');
                    deleteButton.textContent = 'X';
                    deleteButton.classList.add('delete-btn');
                    deleteButton.onclick = function() {
                        wrapper.remove();
                    };
                    wrapper.appendChild(img);
                    wrapper.appendChild(deleteButton);
                    quill.insertEmbed(range.index, 'image', e.target.result);
                };
                reader.readAsDataURL(files[i]);
            }
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        let selectedImage = null;

        document.addEventListener("click", function (e) {
            if (e.target.tagName === "IMG") {
                selectedImage = e.target;
            }
        });
    document.addEventListener("click", function(e) {
        if (e.target.tagName === "IMG") {
            let newSize = prompt("Nhập kích thước mới (px, %):", "300px");
            if (newSize) {
                e.target.style.width = newSize;
            }
            let deleteButton = document.createElement('button');
            deleteButton.textContent = 'X';
            deleteButton.classList.add('delete-btn');
            deleteButton.onclick = function() {
                e.target.remove();
            };
            e.target.parentElement.appendChild(deleteButton);
        }
    });
        document.addEventListener("keydown", function (e) {
            if (selectedImage) {
                let step = 5; // Số pixel di chuyển mỗi lần nhấn phím
                let currentMarginTop = parseInt(selectedImage.style.marginTop || 0);
                let currentMarginLeft = parseInt(selectedImage.style.marginLeft || 0);

                if (e.key === "ArrowUp") {
                    selectedImage.style.marginTop = (currentMarginTop - step) + "px";
                } else if (e.key === "ArrowDown") {
                    selectedImage.style.marginTop = (currentMarginTop + step) + "px";
                } else if (e.key === "ArrowLeft") {
                    selectedImage.style.marginLeft = (currentMarginLeft - step) + "px";
                } else if (e.key === "ArrowRight") {
                    selectedImage.style.marginLeft = (currentMarginLeft + step) + "px";
                }
            }
        });
    });
        document.getElementById("formatContent").addEventListener("click", function () {
        let content = quill.root.innerHTML;

        // Xóa khoảng trắng thừa và căn chỉnh đoạn văn
        content = content.replace(/\s+/g, ' ').trim();

        // Định dạng tiêu đề (nếu có thẻ <h1> hoặc <h2>)
        content = content.replace(/<h1>(.*?)<\/h1>/g, '<h1 style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">$1</h1>');
        content = content.replace(/<h2>(.*?)<\/h2>/g, '<h2 style="font-size: 20px; font-weight: bold; margin-bottom: 8px;">$1</h2>');

        // Định dạng đoạn văn (căn chỉnh justify)
        content = content.replace(/<p>(.*?)<\/p>/g, '<p style="text-align: justify; margin-bottom: 10px;">$1</p>');

        // Định dạng danh sách (nếu có)
        content = content.replace(/<ul>/g, '<ul style="padding-left: 20px; margin-bottom: 10px;">');
        content = content.replace(/<ol>/g, '<ol style="padding-left: 20px; margin-bottom: 10px;">');

        // Cập nhật lại nội dung đã chỉnh sửa vào Quill Editor
        quill.root.innerHTML = content;
    });
</script>
